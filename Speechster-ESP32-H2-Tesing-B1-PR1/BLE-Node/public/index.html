<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Speechster BLE Control Panel</title>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #0d1117;
      color: #e6edf3;
      margin: 20px;
    }
    h1 { color: #58a6ff; }
    button {
      margin: 5px;
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      background: #238636;
      color: white;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background: #2ea043; }
    select {
      padding: 6px;
      margin: 5px;
      border-radius: 6px;
      border: 1px solid #30363d;
      background: #161b22;
      color: #fff;
    }
    #devices button {
      display: block;
      width: 100%;
      text-align: left;
      background: #30363d;
    }
    #devices button:hover { background: #484f58; }
    #inputBox {
      width: 100%;
      height: 60px;
      background: #161b22;
      color: #fff;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 8px;
      font-family: monospace;
      margin-top: 10px;
    }
    #logs {
      margin-top: 20px;
      background: #010409;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 10px;
      height: 300px;
      overflow-y: auto;
      font-family: monospace;
      white-space: pre-wrap;
    }
    .controls {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Speechster BLE Control Panel</h1>

  <div id="devices"></div>

  <div class="controls">
    <h3>Send JSON Command</h3>

    <select id="presetSelect">
      <option value="">-- Choose Preset --</option>
      <option value='{"mic":true}'>ðŸŽ¤ Mic On</option>
      <option value='{"mic":false}'>ðŸ”‡ Mic Off</option>
      <option value='{"fake":true}'>ðŸ§ª Fake Data On</option>
      <option value='{"fake":false}'>ðŸ§ª Fake Data Off</option>
      <option value='{"mode":"adpcm"}'>ðŸŽ§ Use ADPCM</option>
      <option value='{"mode":"pcm"}'>ðŸŽ§ Use PCM</option>
      <option value='{"volume":8}'>ðŸ”Š Set Volume = 8</option>
    </select>
    <button id="clearLogs">Clear Logs</button>

    <textarea id="inputBox" placeholder='Type a JSON command, e.g. {"mic":true}'></textarea><br>
    <button id="sendBtn">Send Command</button>
  </div>

  <div id="logs"></div>

  <script>
    const ws = new WebSocket('ws://localhost:8080');
    const logs = document.getElementById('logs');
    const devicesDiv = document.getElementById('devices');
    const inputBox = document.getElementById('inputBox');
    const presetSelect = document.getElementById('presetSelect');
    let devices = [];

    ws.onopen = () => log("âœ… Connected to WebSocket server");
    ws.onclose = () => log("âŒ WebSocket disconnected");

    ws.onmessage = event => {
      const data = JSON.parse(event.data);
      switch (data.type) {
        case 'deviceList':
          devices = data.devices;
          devicesDiv.innerHTML = devices.length
            ? devices.map(d => `<button onclick="connect('${d.id}')">${d.name} (${d.rssi} dBm)</button>`).join('')
            : '<i>No Speechster devices found...</i>';
          break;
        case 'notification':
          log(`ðŸ”” Notification: ${data.payload}`);
          break;
        case 'disconnected':
          log('âš ï¸ Device disconnected');
          break;
        case 'services':
          log('ðŸ§© Services discovered: ' + JSON.stringify(data.services));
          break;
        default:
          log(JSON.stringify(data));
      }
    };

    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logs.innerHTML += `[${time}] ${msg}\n`;
      logs.scrollTop = logs.scrollHeight;
    }

    function connect(id) {
      ws.send(JSON.stringify({ type: 'connect', deviceId: id }));
      log(`ðŸ”— Connecting to ${id}...`);
    }

    document.getElementById('sendBtn').onclick = () => {
      try {
        const json = JSON.parse(inputBox.value);
        ws.send(JSON.stringify({ type: 'send', payload: json }));
        log('âž¡ï¸ Sent: ' + JSON.stringify(json));
      } catch (err) {
        log('âŒ Invalid JSON: ' + err.message);
      }
    };

    document.getElementById('clearLogs').onclick = () => {
      logs.innerHTML = '';
      log('ðŸ§¹ Logs cleared');
    };

    presetSelect.onchange = () => {
      if (presetSelect.value) {
        inputBox.value = presetSelect.value;
        log(`âœ¨ Loaded preset: ${presetSelect.options[presetSelect.selectedIndex].text}`);
      }
    };
  </script>
</body>
</html>
